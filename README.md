# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Данные и типы данных, используемы в приложении

Карточка

```
export interface ICard { 
  id: string;
  image: string;
  title: string;
  category: string;
  price: number | null;
  description?: string;
}
```

Заказ

```
export interface IOrder {
  items: string[];              // id товаров
  address: string;              
  email: string;                
  phone: string;                
  payment: 'online' | 'cash';   
  total: number;                
}
```

Ответ сервера после создания заказа

```
export interface IOrderResult {
  id: string;
  total: number;
}
```

Модель заказа внутри приложения

```
export interface IOrderModel {
  setData(inputData: Record<string, string>): void;
  getData(): Record<string, string>;
  getErrors(): Record<string, string>;
  isValid(): boolean;
  toApiOrder?(items: string[], total: number): IOrder; // метод для API
}
```

Интерфейс для формы в чекауте

```
export interface IOrderForm {
  payment: 'online' | 'cash';
  address: string;
  email: string;
  phone: string;
}
```

Модалки

```
export type ModalContentType = 'product' | 'basket' | 'checkoutStep1' | 'checkoutStep2';
```

```
export interface IModalData {
  content: HTMLElement | ModalContentType;
  card?: ICard;
}
```

Категории

```
export interface ICategory {
  name: string;
  className: string;
}
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления — отвечает за отображение данных на странице, 
- слой данных — отвечает за хранение и изменение данных,
- презентер — отвечает за связь представления и данных.


### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

#### Категории карточек
Используется для отображения категорий карточек с соответствующим CSS-классом.

#### Класс Component
Базовый класс для всех визуальных компонентов (карточки, модалки, формы).
- container: HTMLElement — корневой DOM-элемент компонента

Методы:
- render(): HTMLElement — вернуть корневой DOM-элемент
- show(): void — показать элемент (добавить класс _active)
- hide(): void — скрыть элемент
- abstract setData(data: T): void — обновление данных в наследниках
- toggleClass(element, className, force?) — переключить CSS-класс
- setText(element, value) — установить текст
- setDisabled(element, state) — заблокировать/разблокировать элемент
- setHidden(element) / setVisible(element) — скрыть/показать элемент
- setImage(element: HTMLImageElement, src: string, alt?) — установить изображение и alt

#### Шаблоны (templates)
Утилита для работы с DOM-шаблонами. Используется для быстрого клонирования HTML-шаблонов и доступа к основным контейнерам страницы.


### Слой данных (Модель)

#### Класс CardsModel
CardsModel управляет загрузкой и хранением карточек товаров в приложении. Он взаимодействует с API для получения данных и использует систему событий для уведомления других компонентов о изменениях.
- private cards: ICard[] — Массив, хранящий загруженные карточки товаров.
- private events: IEvents — Объект для управления событиями.

Методы:
- setCards(cards: ICard[]): void — устанавливаем карточки из вне.
- getCards(): ICard[] — Возвращает массив всех загруженных карточек товаров.
- getCardById(id: string) — ICard | undefined: Находит и возвращает карточку товара по её идентификатору. Возвращает undefined, если карточка с данным ID не найдена.

#### Класс BasketModel
BasketModel — класс, отвечающий за управление корзиной товаров. Хранит добавленные товары, считает их общую стоимость и предоставляет методы для работы с корзиной.
- private items: ICard[] — массив объектов карточек, находящихся в корзине.
- private totalPrice: number — общая стоимость товаров в корзине.

Методы: 
- private calculateTotal(): number — Вычисляет суммарную стоимость всех товаров в корзине. Используется внутри класса для актуализации значения totalPrice.
- addItem(item: ICard): void — Добавляет товар в корзину, если его там ещё нет. После добавления обновляет общую стоимость товаров.
- removeItem(id: string): void — Удаляет товар по его идентификатору из корзины. После удаления пересчитывает общую стоимость.
- clear(): void — Очищает корзину и сбрасывает общую стоимость товаров.
- getItems(): ICard[] — Возвращает копию массива товаров в корзине.
- getTotalPrice(): number — Возвращает общую стоимость всех товаров в корзине.
- isInCart(id: string): boolean — Проверяет, находится ли товар с данным идентификатором в корзине.

#### Класс OrderModel
Класс для хранения и валидации данных заказа.
- data — данные заказа (адрес, email, телефон, способ оплаты).
- errors — ошибки валидации полей.

Методы:
- setData(data) — обновляет данные и валидирует их.
- getData() — возвращает текущие данные.
- getErrors() — возвращает ошибки валидации.
- getErrorMessage() — сообщение об ошибке адреса.
- isValid() — проверяет, есть ли ошибки.
- private rules — правила валидации.
- validate(): void — валидация.
- toApiOrder(items, total) — формирует объект для отправки на API.

Валидация: поле address обязательно, минимум 5 символов.

### Слой представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс Page
Класс, отвечающий за отображение главной страницы и управление элементами интерфейса, связанными с каталогом товаров и корзиной.
- container: HTMLElement — контейнер, куда рендерятся карточки товаров.
- cartButton: HTMLButtonElement — кнопка корзины для открытия модального окна с товарами.
- cartCounter: HTMLElement — элемент, отображающий количество товаров в корзине.
- events: IEvents — объект для работы с системой событий (подписка и эмит событий).

Методы:
- renderCards(cards: CardsCatalog[]) — Отрисовывает массив карточек на странице. Заменяет содержимое контейнера на новые карточки.
- addCard(card: CardsCatalog) — Добавляет одну карточку в контейнер без перерендера остальных карточек.
- updateCartCounter(count: number) — Обновляет отображение счетчика товаров на кнопке корзины.
- private initCartButton(): void — слушатель.

#### Класс CardComponent
CardComponent — абстрактный класс для работы с карточками товаров. Наследуется от базового класса Component<ICard> и предоставляет методы для подготовки и отображения базовой информации о карточке.
- protected cardData: ICard — объект с данными текущей карточки.

Два основных метода - protected fillBase(template: HTMLElement, data: ICard): void (метод инициализирует карточку данными и заполняет шаблон элементами) и fillBase (используется наследниками для быстрого заполнения DOM-шаблона карточки стандартными элементами и обеспечивает единый стиль отображения)
- Категория — находит элемент .card__category и устанавливает текст. Если категория совпадает с одним из элементов массива categories, добавляет соответствующий CSS-класс.
- Заголовок — находит элемент .card__title и устанавливает название товара.
- Изображение — находит элемент .card__image и устанавливает src и alt изображения. Если исходный файл .svg, заменяет его на .png.
- Цена — находит элемент .card__price и устанавливает текстовую стоимость: если цена указана, отображается ${data.price} синапсов, иначе 'Бесценно'.

#### Класс CardModal
Класс, отвечающий за отображение модального окна с детальной информацией о товаре. Наследуется от CardsData, чтобы использовать базовую логику рендера карточки.
- events: IEvents — объект для работы с системой событий (подписка и эмит событий).

Методы:
- setData(product: ICard): void — Отображает карточку товара в модальном окне.

#### CardsCatalog
Класс, представляющий карточку товара в каталоге на главной странице. Наследуется от CardsData для использования базовой логики отображения данных карточки.
- cardElement: HTMLElement — корневой DOM-элемент карточки, используемый для отображения и привязки событий.

Методы:
- setData(data: ICard): void — Заполняет карточку данными.

#### Класс BasketModal
Класс, отвечающий за отображение содержимого корзины в модальном окне. Наследуется от Component и использует basketModel для получения текущих товаров.
- listEl: HTMLElement — элемент списка;
- totalEl: HTMLElement — полная стоимость корзины;
- btn: HTMLButtonElement - кнопка;
- _template: HTMLElement - шаблон;
- events: IEvents — брокер событий для взаимодействия с другими частями приложения (например, переход к шагу оформления заказа или обновление корзины).

Методы:
- render(): HTMLElement — возвращает готовый элемент для вставки в .modal__content;
- set list(items: HTMLElement[]) — обновление списка товаров;
- set total(value: number) — обновлдение стоимости корзины;

#### Класс CardBasket
Это класс представления одного товара в корзине.
- element — это HTML-элемент, который будет вставлен в список корзины;

Методы:
- render(): HTMLElement — возвращает готовый HTML-элемент для вставки в DOM.

#### Класс Form
Базовый абстрактный класс для работы с формами. Инкапсулирует общую логику валидации полей, управления кнопкой отправки и отображения ошибок.
- formEl: HTMLFormElement — DOM-элемент формы.
- inputs: NodeListOf<HTMLInputElement | HTMLTextAreaElement> — коллекция всех полей ввода формы.
- submitButton: HTMLButtonElement — кнопка отправки формы.
- errors — элементы для отображения ошибок для каждого поля.
- events: IEvents — брокер событий для взаимодействия с другими частями приложения.

Методы:
- eset(): void — Сбрасывает форму, очищая все поля ввода и скрывая сообщения об ошибках. Также устанавливает кнопку отправки в состояние "неактивна" и вызывает метод onReset.
- getElement(): HTMLFormElement — Возвращает HTML-элемент формы.
- setValid(isValid: boolean): void — Устанавливает состояние кнопки отправки в зависимости от валидности данных формы.
- showInputError(field: string, message: string): void — Отображает сообщение об ошибке для указанного поля ввода.
- hideInputError(field: string): void — Скрывает сообщение об ошибке для указанного поля ввода.
- setError(data: { field: string; value: string; validInformation: string; }): void — Устанавливает сообщение об ошибке для указанного поля на основе переданных данных.
- onReset(): void — Переопределяемый метод, который может быть реализован в классах-наследниках для выполнения дополнительных действий при сбросе формы.
- handleSubmit(): void — Абстрактный метод, который должен быть реализован в классах-наследниках для обработки сабмита формы.
- onFieldChange(field: string, value: string): void — Абстрактный метод, который должен быть реализован в классах-наследниках для обработки изменений в поле ввода.
- initErrors(): void — Инициализирует элементы для отображения ошибок валидации для каждого поля ввода в форме.
- initListeners(): void — Навешивает события для отслеживания изменений в полях ввода и отправки данных формы.

#### Класс DeliveryForm
Форма выбора способа оплаты и ввода адреса доставки. Наследуется от базового класса Form.
- addressInput: HTMLInputElement — поле ввода адреса.
- paymentButtons: HTMLButtonElement[] — кнопки выбора способа оплаты.
- errorsEl: HTMLSpanElement — элемент для отображения ошибок валидации.
- isFirstRender: boolean — флаг, чтобы при первой инициализации не показывать ошибки.

Методы:
- private initPaymentListeners(): void — Устанавливает обработчики событий для кнопок оплаты. При нажатии на кнопку изменяет состояние активной кнопки и эмитирует событие order:fieldChange с информацией о выбранном способе оплаты. Также вызывает валидацию формы.
- private initInputListener(): void — Устанавливает обработчик событий для поля ввода адреса. При вводе данных эмитирует событие order:fieldChange и вызывает валидацию формы.
- private validate(): void — Выполняет валидацию формы. Проверяет, заполнен ли адрес и выбран ли способ оплаты. Отображает ошибки, если они есть, и управляет состоянием кнопки отправки формы.
- public getElement(): HTMLFormElement — Возвращает HTML-элемент формы.
- protected handleSubmit(): void — Обрабатывает событие отправки формы. Если выбран способ оплаты и введён адрес, эмитирует событие checkout:step1Completed, подтверждая успешное завершение первого шага оформления заказа.
- protected onFieldChange(field: keyof IOrderForm, value: string): void — Переопределяет метод из базового класса для эмита события изменения поля и запускает валидацию.
- protected onReset(): void — Переопределяемый метод, который выполняется при сбросе формы. Очищает поле адреса и скрывает сообщения об ошибках, сбрасывает состояние кнопок оплаты.

#### Класс ContactForm
Форма ввода контактных данных (Email и телефон). Наследуется от базового класса Form.
- private phoneInput: HTMLInputElement;
- private emailInput: HTMLInputElement;

Методы:
- private initFieldListeners() — Добавляет обработчики событий для полей ввода: форматирует номер телефона при вводе и отправляет событие order:fieldChange и отправляет событие для изменения email.
- protected onFieldChange(field: keyof IOrderForm, value: string) — Метод для обработки изменения полей, отправляет соответствующее событие.
- protected handleSubmit() — Обрабатывает отправку формы, если кнопка не заблокирована, отправляя событие checkout:step2Completed.
- private formatPhone(value: string): string — Форматирует введенный номер телефона в виде +7 (XXX) XXX-XX-XX.
- protected onReset() — Очищает поля ввода при сбросе формы.

#### Класс OrderSuccessView
OrderSuccessView — класс, представляющий компонент для отображения успешного завершения заказа. Этот класс наследует функциональность от базового класса Component и управляет визуализацией и взаимодействием в модальном окне.
- private events: IEvents — Объект для управления событиями, позволяющий взаимодействовать с остальной частью приложения.
- private modal: Modal — Модальное окно, которое используется для отображения сообщения об успешном завершении заказа.
- private descriptionEl!: HTMLParagraphElement — Элемент для отображения описания успешного завершения заказа.
- private closeBtn!: HTMLButtonElement — Кнопка для закрытия модального окна.

Методы:
- setData(total: number): void — Устанавливает содержание параграфа с сообщением об успешном завершении заказа, добавляя информацию о списанной сумме (в данном случае — количество синапсов).
- render(): HTMLElement — Возвращает контейнер компонента для отображения в пользовательском интерфейсе.


#### Класс Modal
Класс управления модальными окнами. Наследуется от базового класса Component.
Методы:
- modal: HTMLElement — контейнер модального окна.
- contentEl: HTMLElement — контейнер для содержимого модалки.
- closeBtn: HTMLElement — кнопка закрытия модального окна.
- events: IEvents — брокер событий для взаимодействия с другими компонентами.

Методы:
- setData(data: IModalData): void — Устанавливает содержимое модалки и открывает её. Эмитит событие modal:update с типом контента и, при наличии, объектом карточки товара.
- open(): void — Открывает модальное окно, блокирует прокрутку страницы и эмитит событие modal:open.
- close(): void — Закрывает модальное окно, снимает блокировку прокрутки, очищает содержимое и эмитит событие modal:close. Также очищает ошибки формы, если они присутствуют.
- isActive(): boolean — Проверяет, активно ли модальное окно (наличие класса modal_active).


### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.


### Слой презентера

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События, связанные с карточками товаров*
- `cards:loaded` — когда карточки товаров успешно загружены с сервера.
- `card:selected` — при нажатии на карточку товара для отображения подробной информации.
- `card:added` — когда товар добавлен в корзину.
- `card:deleted` — при удалении товара из корзины.

*События, связанные с корзиной*
- `basket:opened` — при открытии модального окна корзины.
- `basket:closed` — при закрытии модального окна корзины.
- `checkout:started` — при нажатии на кнопку "Оформить заказ".

*События, связанные с оформлением заказа*
- `checkout:step1Completed` — после успешного заполнения формы оплаты и адреса доставки.
- `checkout:step2Completed` — после успешного ввода почты и телефона.
- `order:completed` — после успешного оформления заказа.

*События, связанные с пользовательским интерфейсом*
- `modal:opened` — при открытии модального окна.
- `modal:closed` — при закрытии модального окна.
- `navigation:backToProducts` — когда пользователь нажимает кнопку "Вернуться к списку товаров".

*События, связанные с ошибками и валидацией*
- `form:validationError` — когда происходит ошибка валидации формы.
- `form:validationSuccess` — когда все поля формы прошли валидацию.
